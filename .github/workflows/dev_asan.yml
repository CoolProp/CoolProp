name: run address sanitizer
on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
jobs:
  Matrix-build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        python-version: [3.13]  # Could add more here, but it just makes the build matrix bigger
    steps:
      - name: checkout
        uses: actions/checkout@v4
      - name: checkout submodules
        run: git submodule update --init --recursive
      - name: mkdir
        run: mkdir build && cd build
      - name: cmake config
        run: cd build && CXX=clang++ cmake .. -DCMAKE_BUILD_TYPE=Asan -DCOOLPROP_ASAN=ON -DCOOLPROP_CATCH_MODULE=ON
      - name: build all Catch tests
        run: cmake --build build --config Asan
      - name: Add Homebrew to $PATH
        # See: https://github.com/actions/runner-images/issues/6283#issuecomment-1260838338
        run: echo "/home/linuxbrew/.linuxbrew/bin:/home/linuxbrew/.linuxbrew/sbin" >> $GITHUB_PATH
      - name: run all the compiled Catch tests with address sanitizer
        run: cd build && ASAN_OPTIONS=detect_stack_use_after_return=1:verbosity=1 ASAN_SYMBOLIZER_PATH=`brew --prefix`/opt/llvm/bin/llvm-symbolizer ./CatchTestRunner --benchmark-samples 1
        # ASAN CLI docs here: https://github.com/google/sanitizers/wiki/AddressSanitizerFlags
